# 日志动态开关下发业务

## 名词解释

- **OPush**：OPPO推送平台，在管理部门注册后，可以通过OPush后台界面，或者使用SDK发起推送
- **反馈工具箱**：内部抓取日志的内置APK
- **反馈工具箱后台**：可以处理http请求，或者接收上传的日志

## OPush注册业务

开机后，常驻进程olc service启动，进程启动时，向OPush注册，获取registerID。

此处有判断函数，检查registerID是否为空或非法。如果是合法regID，再储存到本地（kv格式且始终不变，因此使用SharedPreference）。同时，将这个合法的regID结合本地手机中的DUID上传至反馈工具箱后台。

这时，后台使用者就可以通过DUID查看该手机是否已经向OPush注册成功。

如果后台看到注册成功，那么反馈工具箱后台的使用者就可以配置开关的json和有效期，并生成唯一的taskID。json中包括故障场景类型，以及开关配置。接着，反馈工具箱后台调用OPush SDK接口，传递taskID、有效期（不传递json），进行推送。

## OPush推送业务

OPush下发通知到olc常驻进程，消息包括taskID以及有效期。紧接着，olc常驻进程会向日志工具后台索要开关配置，此时存在"向后台索要开关配置成功"与"向后台索要开关配置不成功"两种情况。

如果成功，则会存储配置等信息到本地数据库；如果不成功，就不会向数据库中存储。

**关键点**：静态注册广播，可以唤醒非常驻进程，因此技术上是通过这种方式在非常驻进程中处理收到的开关配置。

收到后，数据库中才会第一次存在这个taskID，并且包括了对应的开关配置、有效期等信息。

## 日志抓取业务

非常驻进程存储成功后，会向后台服务器发送："用户已经成功收到配置"的状态。业务方看到用户成功完成准备工作后，就可以通知用户抓取日志了。

用户打开APK界面后，同样会唤醒非常驻进程。在APK界面选择故障场景类型，开始抓取日志，会将故障类型的信息传递给下层非常驻进程。

## ContentProvider的使用

由于OPush后台不稳定，且第一次向OPush注册是在开机不久后，因此为了提高开关推送的成功率，具体而言是为了提高注册OPush的成功率，因此加入如下机制：

非常驻进程启动后，尝试使用ContentProvider，向常驻进程进行query，query的实现中包括一次判断，如果已经有regID，则可以通过SharedPreference直接获取到并返回；如果没有regID，则会触发向OPush后台注册并获取regID的操作；如果之前获取失败，而此时只要网络正常，通常都会获取成功。

从使用者角度，如果后台管理者查询不到推送目标用户的DUID，会建议用户打开反馈工具箱并进行任意抓取操作，保证能够唤醒非常驻进程。这样，可以确保后台收到此机器的regID，使得后续推送顺利进行。

## 开关触发逻辑

非常驻进程收到消息，会到数据库中查询对应故障场景是否有开关。此时有两种情况：

1. **用户选错了类型**：由于数据库中查询不到，因此不会触发开关
2. **用户选择了正确的类型**：非常驻进程查询到开关，将json解析后，继续向下传递，触发开关配置

假设用户选择了正确的类型，此时非常驻进程会设置本地状态为："开关收到，且用户正在抓取日志"。

此时，用户可以选择：取消抓取，或者等待抓取成功。

- **取消抓取**：状态更新回"用户已经成功收到配置"
- **抓取成功**：状态变为"用户抓取成功，但日志尚未上传"

抓取完毕后，会立刻尝试向反馈工具箱后台上传日志。上传完毕后，后台状态会更新为："用户抓取成功，日志上传成功"。

此时，后台可以将配置下发和日志上传闭环，也即：下发开关给指定用户，用户按要求抓取到所需日志。

全流程结束。
