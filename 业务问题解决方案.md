# 业务问题解决方案

## CPU Top Stats

**典型场景**：通过配置文件配置预警条件，在CPU负载达到97%时，抓取系统日志和systrace分析原因。借助StatsD的预警和OLC接口，实现任意条件触发，抓trace。

### 如何触发抓trace？

由OLC修改系统property，系统中管理perfetto的服务先拼接config，再用system函数执行perfetto的cmd命令。

### 抓trace后如何分析？

通过perfetto UI分析trace文件，可以查看：
- CPU调度情况
- 进程和线程的执行时间线
- 系统调用和函数调用栈
- 锁竞争和等待时间
- 内存分配和释放情况

结合系统日志，可以定位CPU高负载的根本原因，如：
- 某个进程或线程占用CPU时间过长
- 频繁的系统调用或中断
- 锁竞争导致的线程阻塞
- 内存分配导致的GC压力

## 温升

可以在大数据中看到对温度产生影响的因素（例如：屏幕亮度、相机使用、网络、IO、前台应用、top进程线程等）。

按照温度等级结算后，也可以看到不同时间段系统中的事件，包括温控策略，可以反过来看温控策略对温度的影响。

通过温升用户画像（此用户的top温升原因）可以针对这个用户进行定制化的温控策略推送。

## SurfaceFlinger

收集屏幕刷新的数据，可以评估合入某个feature的影响，或评估不同项目（屏幕性能）的用户体验差距。

按照应用结算，可以看到同一应用下不同feature或屏幕的影响，也可以评估某个应用的显示性能水准。

统计亮度区间，可以根据用户习惯优化亮度曲线，优化功耗表现。

## 推送RUS统计指标

实现是：用一份自定义的config（其中包括一份完整的StatsD config）上传Gauge/Event的report字符串。

- 某个季节或者某个省份的用户的电池温度情况（一小时alarm作为trigger）
- 针对版本推送，可以看到版本升级后，对某个指标的改善情况，例如桌面卡顿之类

## Midas日志，借助Minos分析问题流程

监控或上报耗电快问题后，查到每日上传的midas日志（sqlite db格式），并通过Minos（一个db转trace的python项目）转换到perfetto UI中，可以帮助专项组初步定位功耗问题模块。

## 算法加速项目补充

### HVX指令优化

在DSP上使用HVX（Hexagon Vector eXtensions）指令进行并行计算，包括：
- 拼接、移位、拆分、打包等向量操作
- 使用内置指令操作L2 Cache

### L2 Cache优化

**如何做到的？** 使用内置指令进行L2 Cache预取。

参考链接：https://www.cnblogs.com/Linux-tech/p/13873880.html

存取相比于L1有一定延迟，但通过合理的预取策略可以显著提升性能。

### 算法优化示例

#### 例1：对一个输入矩阵取绝对值

**C++ 一般实现方法**：
```cpp
for (int i = 0; i < size; i++) {
    result[i] = abs(input[i]);
}
```

**HVX 实现方法**：
```cpp
// 使用HVX向量指令，一次处理128个元素
Q6_Vh_abs_Vh(input_vector);
```

通过上面的对比可以看出，HVX并行处理可以大大减少循环次数，只有原来的128分之一，显著提高运算效率。其中的`Q6_Vh_abs_Vh()`这个函数是HVX封装的intrinsic接口。可以通过查询HVX programming guide文档选择合适的指令。

#### 例2：使用L2 Cache加速

使用L2 Cache提前将fetch需要访问的数据，能使内存读取的速度提高一倍以上。

需要注意几点：

1. 需要提前prefetch
2. 三条以上的fetch指令，如果前面的fetch指令没有执行完会被后面的冲掉
3. fetch的内容读取比较快，写入有时会很慢，可能有cache miss
4. 通常fetch 8KB以下，多发出几个fetch指令效果会比较好
