# 项目经历

## OPPO 上海

### 日志动态开关下发&开关精简 (Java/Kotlin) 2024.06

#### 业务描述

- 动态配置开关项
- 下发给用户并更新端侧和后台状态
- 规定后台协议
- 简化用户界面及操作

#### 技术方案

- 在常驻进程中实现透传消息的接收，在非常驻进程中处理消息并更新状态
- 使用GlobalScope配合okhttp发起网络请求
- 使用Broadcast和ContentProvider实现跨进程通信
- 使用SharedPreference存储registerID等数据
- 使用DAO模式存储动态开关配置，实现业务逻辑和数据访问逻辑的隔离
- 使用EventBus进行事件驱动编程，实现本地状态更新

#### 遇到问题及解决方案

- **小概率DAO查询失败**：
  - 优化实体类实现
  - 优化DAO实现类及接口，查询结果以List返回，按时间降序，并清理多余条目
  - 使用BigDecimal代替Long.parseLong解析时间戳字符串

- **改变用户操作习惯，导致遇到领域开发测试阻力**：
  - 沟通测试负责人，临时下架测试用例并整改
  - 跨部门沟通十余个领域开发测试，大范围宣讲+小范围沟通
  - 跟项目经理、敏捷组长及时同步状态，争取资源

### 无痕埋点&StatsD (C++/Java/SQL/Python) 2022.05-2024.04

#### 业务描述

- **温升大数据&用户画像**
  - 温升业务领域埋点上报
  - 按照时间/温度区间结算
  - 总结用户温升TOP因素
  - 总结温升领域用户画像

- **SurfaceFlinger埋点**
  - 对于复杂结算，实现其后处理逻辑
  - 对于简单结算，提出方案并指导业务领域直接上传
  - 提供单机调试方法以及数据验证方式

- **其他Atom埋点**
  - 上报埋点到原生的StatsD模块
  - 接收埋点，实现预警

#### 技术方案

- 使用注册回调添加pulled atom，底层实现为binder
- 使用库函数上报pushed atom，底层实现为socket
- 在APK、Framework、native层添加埋点并形成SOP
- 解析Protobuf格式的报告
- 本地文件存储、上传云端，建立数仓、指导创建并解析二级表，提供查询脚本
- 灵活解析多种Metric格式（固定+非固定）
- 使用Python脚本解析生成csv进行数据验证

#### 遇到问题及解决方案

- **非固定格式埋点结算**：
  - 增加埋点field，结合已有Metric机制进行解析

- **Vendor侧进程缺少SELinux权限**：
  - 解耦导致，正确添加hal_client_domain和hal_server_domain

- **预警使用一度不规范**：
  - 分析源码，探索正确使用方式，形成SOP

### 功耗大数据 2021.05-2022.05

#### 业务描述

- **端侧大数据**
  - 按照事件结算模块功耗，保证误差达标
  - 提供云端查询方式
  - 承接大小屏功耗、长短待机功耗等需求
  - 提供AIDL接口，对外发送数据

#### 技术方案

- 使用读节点或binder方式获取原始数据
- 从APK侧监听setting状态，通过AIDL接口传递给native侧
- 使用生产者-消费者模式的消息队列，实现事件驱动编程
- Display模块采用获取CWB截屏和白名单结合的方式进行功耗计算
- 规定接口：注册DeathRecipient，以及使用protobuf发送数据
- 使用map保存binder对象的shared_ptr，实现一对多注册及通信

#### 遇到问题及解决方案

- **调用CWB接口导致电流方波**：
  - 编译对比版本，确定问题根因
  - 使用白名单规避方案代替CWB实时计算，牺牲10%左右精度，适配中低端机型

- **接手错误的Display功耗模型**：
  - 拉通能耗设计部门，根据显示原理提出进一步优化方案
  - 设计验证实验，并规定新的测试、适配流程

- **云侧看板取数跑数效率低**：
  - 优化SQL query语句，优化查询流程

### 图片滤镜算法移植及优化 (C++/C) 2020.07-2020.09

#### 业务描述

- 在MTK及高通的DSP平台上移植并优化图片滤镜算法

#### 技术方案

- 使用mk文件编译Android NDK可执行文件
- 编译so库并在代码中引用
- 还原C版本的代码，使用数学推导优化算法
- 使用整数计算代替浮点数计算
- 将数据映射到DRAM上操作
- 在DSP上使用多线程并行
- 减少内存拷贝操作
- 使用Ping-Pong Buffer在L2 Cache中交接数据，提高读写操作效率

#### 遇到问题及解决方案

- **高通DSP不提供除法及浮点数运算**：
  - 使用乘法+位运算，注意溢出及精度问题

- **小概率Segmentation fault**：
  - 使用压测手段稳定复现
  - 在正确位置回收内存
