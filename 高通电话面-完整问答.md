# 高通电话面 - 完整问答

## 通用问题

### 1. 为什么转行？

**回答**：

我本科和研究生都是土木工程专业，但在学习过程中发现自己对编程和计算机技术有浓厚的兴趣。在研究生期间，我通过自学掌握了编程基础，并在2020年获得了OPPO的实习机会，将图像算法移植到MTK及高通的DSP平台上进行优化。通过这次实习，我发现自己对底层软件开发、性能优化和系统架构设计非常感兴趣，也获得了部门唯一次顶薪offer。因此，我决定转行到软件开发领域，并在OPPO工作了3年多，积累了丰富的Android底层开发、大数据端侧和日志框架开发经验。

### 2. 为什么离职？

**回答**：

在OPPO工作期间，我主要负责大数据端侧和日志框架的开发，积累了丰富的Android底层开发经验。离职主要是为了寻求新的职业发展机会和挑战。目前我在华为OD的OpenHarmony部门担任软件开发工程师，专注于性能看板、基线管理等项目的开发，使用Rust、Python等更多技术栈，也获得了C++可信专业级认证和A绩效。这次离职是职业规划的一部分，希望能在新的平台上继续提升自己的技术能力和项目经验。

## 询问项目

### 3. 算法移植项目：如何优化？为什么要放到DSP实现？

**回答**：

**优化方法**：

1. **算法层面优化**：
   - 使用数学推导优化算法，减少计算复杂度
   - 使用整数计算代替浮点数计算，提高运算速度
   - 使用乘法+位运算代替除法运算（因为高通DSP不提供除法及浮点数运算）

2. **内存优化**：
   - 将数据映射到DRAM上操作，减少内存拷贝次数
   - 使用Ping-Pong Buffer在L2 Cache中交接数据，提高读写操作效率
   - 在正确位置回收内存，避免内存泄漏

3. **并行优化**：
   - 在DSP上使用多线程并行处理
   - 使用HVX（Hexagon Vector eXtensions）指令进行向量化计算，一次处理128个元素，效率提升128倍

4. **编译优化**：
   - 使用mk文件编译Android NDK可执行文件
   - 编译so库并在代码中引用

**为什么要放到DSP实现**：

1. **性能优势**：DSP（数字信号处理器）专门为数字信号处理设计，具有强大的并行计算能力和高效的指令集，特别适合图像处理、滤波等算法
2. **功耗优化**：DSP的功耗比CPU低，在移动设备上可以显著降低功耗
3. **释放CPU资源**：将计算密集型任务卸载到DSP，可以让CPU专注于其他任务，提高系统整体性能
4. **实时性要求**：图像处理算法对实时性要求高，DSP的专用架构可以保证处理速度

### 4. 端侧功耗大数据：跨度大

**回答**：

端侧功耗大数据项目从2021年5月到2022年5月，跨度确实比较大。这个项目涉及多个模块的开发：

1. **数据采集**：使用读节点或binder方式获取原始数据（CPU、Battery、Display等模块的功耗数据）
2. **数据处理**：在Android Native层daemon进程中，按照事件结算模块功耗，保证误差达标
3. **数据存储**：使用SQLite存储功耗数据，建立预警条件、下发SQL trigger策略
4. **数据上报**：提供AIDL接口，对外发送数据，支持云端查询
5. **业务支持**：承接大小屏功耗、长短待机功耗等需求

项目从2.0阶段（Android 10，APK共进程）演进到3.0阶段（Android 11，迁移到native层），架构发生了重大变化，这也增加了项目的复杂度。

### 5. Display模块：起了服务导致额外开销，和什么对比？功耗板是如何采集功耗的？从哪里获取的？折算4V

**回答**：

**额外开销对比**：

Display模块的功耗计算采用获取CWB（Color Wheel Buffer）截屏和白名单结合的方式。起服务会导致额外的功耗开销，主要是与**功耗板**（硬件功耗测试设备）的测量结果进行对比。

**功耗板采集方式**：

功耗板是硬件测试设备，通过以下方式采集功耗：

1. **采集位置**：功耗板通过物理连接测量整机或特定模块的电流和电压
2. **数据来源**：从PMIC（Power Management Integrated Circuit，电源管理集成电路）或电池管理芯片获取电流数据
3. **折算方式**：功耗板测量的是电流值（单位：mA），需要乘以电压（通常是4V，即电池电压）来得到功耗值（单位：mW）
   - 功耗 = 电流 × 电压 = mA × 4V = mW

**软件层面优化**：

高通组评估时，根据老平台预估下一代平台功耗，如果实际功耗超出预期，需要在软件层面进行优化：

1. **降低Display功耗**：优化屏幕亮度曲线、减少不必要的刷新、优化背光控制
2. **优化服务开销**：减少不必要的服务调用、优化CWB接口使用频率
3. **白名单机制**：对于中低端机型，使用白名单规避方案代替CWB实时计算，牺牲10%左右精度以降低功耗

### 6. Battery：是从Gauge中获取的吗？评估Gauge损耗，PMIC拿到的？

**回答**：

**数据来源**：

Battery功耗数据主要通过以下方式获取：

1. **Battery Gauge（电池电量计）**：
   - Gauge是专门用于测量电池电量、电压、电流、温度等参数的芯片
   - 通过I2C或SMBus接口与主控芯片通信
   - 提供准确的电池状态信息，包括剩余电量、充放电电流、电池健康状态等

2. **PMIC（Power Management Integrated Circuit）**：
   - PMIC是电源管理集成电路，负责管理系统的电源分配和功耗控制
   - 可以提供实时的电流和电压数据
   - 通过读取PMIC的寄存器可以获取各模块的功耗信息

**Gauge损耗评估**：

Gauge本身也有一定的功耗损耗，需要评估：

1. **Gauge自身功耗**：Gauge芯片在工作时会消耗一定的电流（通常很小，在微安级别）
2. **通信开销**：通过I2C/SMBus读取Gauge数据时会有通信开销
3. **采样频率**：过高的采样频率会增加Gauge的负载和功耗

在实际项目中，我们通过以下方式优化：

- 合理设置采样周期，避免过度频繁读取
- 使用缓存机制，减少不必要的Gauge访问
- 评估Gauge损耗对整体功耗的影响，确保在可接受范围内

### 7. 聚合，hourly数据，daily数据。业务角度理解，大数据的目的、作用是什么？数据量大吗？有哪些数据结构？采样周期，采样事件？呈现的是什么结果？

**回答**：

**数据聚合**：

- **Hourly数据**：按小时聚合的功耗数据，用于分析短期功耗趋势
- **Daily数据**：按天聚合的功耗数据，用于分析长期功耗模式和用户习惯

**大数据的目的和作用**：

1. **功耗优化**：
   - 识别功耗热点，定位高功耗模块和应用
   - 评估软件优化效果，指导功耗优化方向
   - 对比不同版本、不同机型的功耗表现

2. **用户体验提升**：
   - 分析用户使用习惯，优化系统策略
   - 识别异常功耗场景，及时处理问题
   - 提供个性化优化建议

3. **项目适配跟踪**：
   - 跟踪项目适配进度，确保功耗达标
   - 支持大小屏功耗、长短待机功耗等专项需求
   - 为产品规划提供数据支撑

**数据量**：

数据量较大，主要包括：

- **原始数据**：每秒或每分钟采集的功耗数据
- **聚合数据**：按小时、按天聚合的数据
- **事件数据**：亮灭屏、应用切换、网络状态变化等事件
- **用户数据**：不同用户、不同场景的功耗数据

**数据结构**：

1. **事件驱动数据**：按事件（亮屏、灭屏、应用启动等）结算的功耗数据
2. **时间序列数据**：按时间序列记录的功耗数据
3. **模块分类数据**：按模块（CPU、Display、Battery、Network等）分类的功耗数据
4. **聚合统计数据**：按时间、按模块、按场景聚合的统计数据

**采样周期和采样事件**：

- **采样周期**：根据需求设置，通常为1秒到1分钟不等
- **采样事件**：
  - 系统事件：亮灭屏、充电状态变化、网络状态变化
  - 应用事件：应用启动、应用切换、前后台切换
  - 硬件事件：CPU频率变化、屏幕亮度变化、温度变化

**呈现的结果**：

1. **功耗报告**：各模块的功耗占比、功耗趋势图
2. **异常分析**：异常功耗场景的识别和分析
3. **对比分析**：不同版本、不同机型的功耗对比
4. **用户画像**：用户使用习惯和功耗模式分析
5. **优化建议**：基于数据的功耗优化建议

### 8. 高通团队中也有做功耗大数据的。1、拿到有什么用？2、呈现的结果？

**回答**：

**1. 拿到有什么用？**

功耗大数据对高通团队的价值：

1. **芯片设计优化**：
   - 了解实际使用场景下的功耗表现，指导下一代芯片的功耗设计
   - 识别功耗瓶颈，优化芯片架构和电源管理策略

2. **平台评估和验证**：
   - 根据老平台数据预估下一代平台功耗，验证设计目标
   - 如果实际功耗超出预期，指导软件层面的优化方向

3. **客户支持**：
   - 帮助OEM厂商优化功耗，提升产品竞争力
   - 提供功耗分析和优化建议，支持客户项目

4. **技术积累**：
   - 建立功耗数据库，积累不同场景、不同应用的功耗数据
   - 为后续产品开发提供参考

**2. 呈现的结果？**

呈现的结果包括：

1. **功耗报告**：
   - 各模块（CPU、GPU、Display、Network等）的功耗占比
   - 不同场景（游戏、视频、待机等）的功耗表现
   - 功耗趋势图和对比分析

2. **异常分析**：
   - 异常功耗场景的识别和定位
   - 功耗突增的原因分析
   - 优化建议和解决方案

3. **用户画像**：
   - 用户使用习惯分析
   - 不同用户群体的功耗模式
   - 个性化优化建议

4. **版本对比**：
   - 不同软件版本的功耗对比
   - 优化效果评估
   - 回归问题识别

### 9. 亮屏的时候的CPU low power mode？小核active起一两个小核跑一些服务，其他核wait for interrupt WFI等待中断，Sleep，Deep Sleep，Idle状态。4个状态，进出条件。哪些功能用不了？例如游戏场景只用一两个小核跑

**回答**：

**CPU低功耗模式（4个状态）**：

1. **Active（活跃状态）**：
   - **描述**：CPU核心完全活跃，执行指令
   - **进入条件**：有任务需要执行，调度器分配任务到该核心
   - **退出条件**：任务执行完成，进入WFI状态
   - **功耗**：最高
   - **功能**：所有功能可用

2. **WFI（Wait For Interrupt，等待中断）**：
   - **描述**：CPU核心暂停执行，等待中断唤醒
   - **进入条件**：任务队列为空，核心进入空闲状态
   - **退出条件**：收到中断信号（定时器中断、设备中断等）
   - **功耗**：较低，但核心仍保持供电
   - **功能**：核心暂停，但可以快速响应中断

3. **Sleep（睡眠状态）**：
   - **描述**：CPU核心进入更深层的睡眠，时钟关闭
   - **进入条件**：系统进入低功耗模式，所有核心空闲
   - **退出条件**：收到唤醒中断（RTC、按键、网络等）
   - **功耗**：很低，核心时钟关闭
   - **功能限制**：
     - 核心无法执行指令
     - 需要一定时间才能唤醒（唤醒延迟）
     - 部分外设可能关闭

4. **Deep Sleep（深度睡眠状态）**：
   - **描述**：系统进入最深层睡眠，大部分模块关闭
   - **进入条件**：系统长时间空闲，进入深度睡眠模式
   - **退出条件**：收到特定唤醒源（RTC、按键等）
   - **功耗**：极低，大部分模块断电
   - **功能限制**：
     - CPU无法执行指令
     - 大部分外设关闭
     - 内存可能进入自刷新模式
     - 唤醒时间较长（几百毫秒到几秒）
     - 网络连接断开，需要重新连接

**亮屏时的CPU状态**：

在亮屏状态下，系统通常采用以下策略：

- **小核Active**：1-2个小核保持活跃，运行系统服务和轻量级任务
- **其他核心WFI**：其他核心（包括大核和其他小核）进入WFI状态，等待任务分配
- **动态调度**：根据负载情况，动态唤醒核心执行任务

**游戏场景**：

在游戏场景下，系统会根据游戏需求调整CPU状态：

- **轻度游戏**：可能只使用1-2个小核，其他核心保持WFI或Sleep状态
- **重度游戏**：会唤醒大核，多个核心同时工作，保证游戏流畅度
- **功耗平衡**：在性能和功耗之间平衡，避免过度唤醒核心导致功耗过高

### 10. htrace显示了哪些东西？解析Trace的看板，不是实时显示的？只是一个解析trace的脚本，是高通每个校招生第一个做的事情。ftrace

**回答**：

**htrace显示的内容**：

htrace（或类似的trace工具）可以显示：

1. **CPU调度信息**：
   - 进程和线程的调度时间线
   - CPU频率变化
   - CPU负载分布

2. **系统调用**：
   - 系统调用的时间点和耗时
   - 系统调用的调用栈

3. **中断和异常**：
   - 中断发生的时间点
   - 中断处理耗时

4. **锁竞争**：
   - 锁的获取和释放
   - 锁等待时间

5. **内存操作**：
   - 内存分配和释放
   - 内存拷贝操作

6. **I/O操作**：
   - 文件读写操作
   - 网络I/O操作

**解析Trace的看板**：

解析Trace的看板通常不是实时显示的，而是：

1. **离线解析**：先抓取trace文件，然后通过脚本解析
2. **数据入库**：将解析后的数据存储到数据库中
3. **看板展示**：通过Web界面展示分析结果

这确实是一个常见的入门项目，可以帮助新员工熟悉：
- Trace文件的格式和内容
- 性能分析的基本方法
- 数据处理和可视化

**ftrace**：

ftrace是Linux内核的跟踪框架，可以跟踪：

1. **函数调用**：跟踪内核函数的调用和返回
2. **中断处理**：跟踪中断处理流程
3. **调度事件**：跟踪进程调度、上下文切换等
4. **定时器事件**：跟踪定时器相关事件
5. **内存事件**：跟踪内存分配、释放等事件

ftrace是Android性能分析的重要工具，可以配合perfetto使用，提供更详细的系统行为分析。

### 11. SOC架构，从CPU讲起。ARM或什么架构，有几级缓存？DMA（System Level Cache）？总线？

**回答**：

**SOC架构概述**：

SOC（System on Chip，片上系统）是将CPU、GPU、内存控制器、外设接口等集成在一个芯片上的系统。

**CPU架构**：

1. **ARM架构**：
   - 移动设备主要使用ARM架构（如ARM Cortex-A系列）
   - 采用big.LITTLE架构：大核（性能核）+ 小核（效率核）
   - 支持多核并行处理

2. **其他架构**：
   - x86架构（主要用于PC和服务器）
   - RISC-V架构（新兴的开源架构）

**缓存层级**：

ARM架构通常采用多级缓存结构：

1. **L1 Cache（一级缓存）**：
   - 分为L1 Instruction Cache（指令缓存）和L1 Data Cache（数据缓存）
   - 容量：通常32KB-64KB
   - 延迟：1-2个时钟周期
   - 每个CPU核心独享

2. **L2 Cache（二级缓存）**：
   - 统一缓存（指令和数据共享）
   - 容量：通常256KB-1MB
   - 延迟：5-10个时钟周期
   - 每个CPU核心独享或共享

3. **L3 Cache（三级缓存，System Level Cache）**：
   - 统一缓存，所有核心共享
   - 容量：通常1MB-8MB
   - 延迟：20-40个时钟周期
   - 用于减少内存访问延迟

4. **L4 Cache（可选）**：
   - 某些高端SOC可能还有L4缓存
   - 容量更大，延迟更高

**DMA（Direct Memory Access，直接内存访问）**：

DMA允许外设直接访问内存，无需CPU干预：

1. **作用**：
   - 减少CPU负担，提高系统效率
   - 支持高速数据传输（如视频编解码、网络数据传输）

2. **System Level Cache与DMA**：
   - DMA操作可能涉及System Level Cache（L3 Cache）
   - 需要处理缓存一致性问题（Cache Coherency）
   - 确保DMA传输的数据与CPU缓存一致

**总线架构**：

SOC内部采用多级总线架构：

1. **系统总线**：
   - 连接CPU、内存控制器、系统级外设
   - 如AMBA（Advanced Microcontroller Bus Architecture）总线

2. **外设总线**：
   - 连接各种外设（如I2C、SPI、UART等）
   - 速度较慢，但功耗低

3. **高速总线**：
   - 连接高速外设（如USB、PCIe等）
   - 支持高速数据传输

4. **互连网络**：
   - 现代SOC可能采用NoC（Network on Chip）架构
   - 提供更灵活和高效的互连方式

**总结**：

SOC架构是一个复杂的系统，包括：
- **CPU**：ARM架构，多级缓存（L1/L2/L3）
- **DMA**：直接内存访问，涉及缓存一致性
- **总线**：多级总线架构，连接各个模块
- **其他模块**：GPU、NPU、ISP、音频处理等

这些模块协同工作，实现高性能、低功耗的移动设备系统。

## 面试总结

### 面试官组成

- 现场3-4个，外部1-2个，总共不超过4-5个人
- 主要是盛他们组的（SOC功耗组）
- 还有其他组的老板，业务关联高的

### 评估重点

1. **项目情况**：了解项目经验和技术能力
2. **知识背景是否匹配**：评估是否具备SOC功耗相关的技术背景

### 准备建议

1. **熟悉项目细节**：能够详细描述项目背景、技术方案、遇到的问题和解决方案
2. **补充技术知识**：了解SOC架构、CPU低功耗模式、功耗优化等相关知识
3. **准备业务理解**：能够从业务角度理解大数据的目的和作用
4. **准备问题**：准备一些关于岗位、团队、技术方向的问题

